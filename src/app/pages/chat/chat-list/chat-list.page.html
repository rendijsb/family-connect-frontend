<ion-header [translucent]="true" class="chat-list-header">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-button class="back-button" (click)="goBack()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title class="header-title">
      <div class="title-content">
        <span class="page-title">Family Chat</span>
        <span class="room-count">{{ filteredRooms().length }} rooms</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      @if (totalUnreadCount() > 0) {
        <ion-button class="unread-button">
          <ion-badge class="total-unread-badge">{{
              totalUnreadCount() > 99 ? "99+" : totalUnreadCount()
            }}</ion-badge>
        </ion-button>
      }
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-list-content">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pulling-icon="arrow-down-outline"
      pulling-text="Pull to refresh"
      refreshing-spinner="crescent"
      refreshing-text="Refreshing..."
    >
    </ion-refresher-content>
  </ion-refresher>

  <div class="chat-list-container content-with-header">
    <!-- Search Section -->
    <div class="search-section">
      <ion-searchbar
        placeholder="Search chat rooms..."
        (ionInput)="onSearchChange($event)"
        class="custom-searchbar"
      >
      </ion-searchbar>
    </div>

    <!-- Family Members Section -->
    @if (!isLoading() && availableMembersForDM().length > 0) {
      <div class="family-members-section">
        <div class="section-header">
          <h3 class="section-title">Start a conversation</h3>
          <span class="member-count"
          >{{ availableMembersForDM().length }} members</span
          >
        </div>

        <div class="members-horizontal-list">
          @for (member of availableMembersForDM(); track member.id) {
            <div class="member-quick-item" (click)="startDirectMessage(member)">
              <ion-avatar class="member-avatar">
                <img
                  [src]="
                member.user?.avatar ||
                'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png?20150327203541'
              "
                  [alt]="member.user?.name"
                />
              </ion-avatar>
              <div class="member-info">
                <h4 class="member-name">
                  {{ member.nickname || member.user?.name }}
                </h4>
                <p class="member-role">
                  {{ member.relationship || "Family Member" }}
                </p>
              </div>
              <ion-button
                fill="clear"
                size="small"
                class="message-btn"
                (click)="startDirectMessage(member); $event.stopPropagation()"
              >
                <ion-icon name="send-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          }
        </div>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading() && chatRooms().length === 0) {
      <div class="loading-container">
        @for (i of [1,2,3,4,5]; track i) {
          <div class="skeleton-room">
            <ion-skeleton-text
              animated
              style="width: 48px; height: 48px; border-radius: 50%"
            ></ion-skeleton-text>
            <div class="skeleton-content">
              <ion-skeleton-text
                animated
                style="width: 70%; height: 16px"
              ></ion-skeleton-text>
              <ion-skeleton-text
                animated
                style="width: 50%; height: 14px"
              ></ion-skeleton-text>
            </div>
            <ion-skeleton-text
              animated
              style="width: 20px; height: 12px"
            ></ion-skeleton-text>
          </div>
        }
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading() && filteredRooms().length === 0 && chatRooms().length ===
    0) {
      <div class="empty-state">
        <div class="empty-icon">
          <ion-icon name="chatbubble-outline"></ion-icon>
        </div>
        <h3 class="empty-title">No Chat Rooms</h3>
        <p class="empty-subtitle">
          Create your first chat room to start conversations with your family
          members.
        </p>
        <ion-button (click)="createChatRoom()">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Create Chat Room
        </ion-button>
      </div>
    }

    <!-- No Search Results -->
    @if (!isLoading() && filteredRooms().length === 0 && chatRooms().length > 0
    && searchTerm()) {
      <div class="empty-state">
        <div class="empty-icon">
          <ion-icon name="search-outline"></ion-icon>
        </div>
        <h3 class="empty-title">No Results Found</h3>
        <p class="empty-subtitle">
          Try adjusting your search terms or browse all chat rooms.
        </p>
        <ion-button
          fill="outline"
          (click)="searchTerm.set('')"
        >
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Clear Search
        </ion-button>
      </div>
    }

    <!-- Chat Rooms List -->
    @if (filteredRooms().length > 0) {
      <div class="chat-rooms-list">
        @for (room of filteredRooms(); track trackByRoomId($index, room)) {
          <ion-card
            class="room-card"
            [class.has-unread]="room.unreadCount && room.unreadCount > 0"
            (click)="openChatRoom(room)"
          >
            <ion-card-content class="room-content">
              <div class="room-info">
                <!-- Room Avatar -->
                <div class="room-avatar-section">
                  <div class="room-avatar" [class]="'type-' + room.type">
                    <ion-icon [name]="getChatRoomTypeIcon(room.type)"></ion-icon>
                  </div>

                  @if (room.unreadCount && room.unreadCount > 0) {
                    <ion-badge class="unread-badge">
                      {{ room.unreadCount > 99 ? "99+" : room.unreadCount }}
                    </ion-badge>
                  }
                </div>

                <!-- Room Details -->
                <div class="room-details">
                  <div class="room-header">
                    <h3 class="room-name">{{ room.name }}</h3>
                    <div class="room-meta">
                      @if (room.lastMessageAt) {
                        <span class="last-message-time">{{
                            formatMessageTime(room.lastMessageAt)
                          }}</span>
                      }
                      <ion-button
                        fill="clear"
                        size="small"
                        class="room-menu-btn"
                        (click)="presentRoomOptions(room, $event)"
                      >
                        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
                      </ion-button>
                    </div>
                  </div>

                  <!-- Last Message -->
                  <div class="last-message">
                <span class="message-sender">{{
                    getLastMessageSender(room)
                  }}</span>
                    <span class="message-text">{{
                        getLastMessagePreview(room)
                      }}</span>
                  </div>

                  <!-- Room Info -->
                  <div class="room-info-row">
                    <div class="room-type">
                      <ion-icon [name]="getChatRoomTypeIcon(room.type)"></ion-icon>
                      <span>{{ getChatRoomTypeName(room.type) }}</span>
                    </div>

                    @if (getRoomMemberCount(room) > 0) {
                      <div class="member-count">
                        <ion-icon name="people-outline"></ion-icon>
                        <span>{{ getRoomMemberCount(room) }}</span>
                      </div>
                    } @if (room.isPrivate) {
                    <div class="privacy-indicator">
                      <ion-icon name="lock-closed-outline"></ion-icon>
                    </div>
                  }
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        }
      </div>
    }
  </div>

  <!-- Floating Action Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button class="fab-button" (click)="createChatRoom()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
